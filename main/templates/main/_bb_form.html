{% load django_bootstrap5 %}
{% load static %}

<form method="post" enctype="multipart/form-data" novalidate>
  {% csrf_token %}

  <div class="card shadow-sm p-4 mb-4">
    <!-- Рубрика -->
    <div class="mb-3">
      {{ form.rubric.label_tag }}
      {{ form.rubric }}
      <div class="form-text">Выберите подходящую рубрику.</div>
      {% if form.rubric.errors %}
        <div class="invalid-feedback d-block text-danger">{{ form.rubric.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Название -->
    <div class="mb-3">
      {{ form.title.label_tag }}
      {{ form.title }}
      <div class="form-text"><span id="titleCounter">0</span>/50 символов</div>
      {% if form.title.errors %}
        <div class="invalid-feedback d-block text-danger">{{ form.title.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Описание -->
    <div class="mb-3">
      {{ form.content.label_tag }}
      {{ form.content }}
      <div class="form-text"><span id="contentCounter">0</span>/600 символов</div>
      {% if form.content.errors %}
        <div class="invalid-feedback d-block text-danger">{{ form.content.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Цена -->
    <div class="mb-3">
      {{ form.price.label_tag }}
      {{ form.price }}
      <div class="form-text text-muted" id="priceHelp" data-default-text="Цена: от 0 до 999 999 999 999.99 ₽">
        Цена: от 0 до 999 999 999 999.99 ₽
      </div>
      {% if form.price.errors %}
        <div class="invalid-feedback d-block text-danger fw-bold">{{ form.price.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Контакты -->
    <div class="mb-3">
      {{ form.contacts.label_tag }}
      {{ form.contacts }}
      <div class="form-text">
        <span id="contactsCounter">0</span>/50 символов — например: +7 999 123-45-67 или Telegram @имя.
      </div>
      {% if form.contacts.errors %}
        <div class="invalid-feedback d-block text-danger">{{ form.contacts.errors.0 }}</div>
      {% endif %}
    </div>

    <!-- Главное изображение -->
    <div class="mb-3">
      {{ form.image.label_tag }}

      {# Не хардкодим input вручную: используем Django field, но добавляем attrs #}
      {{ form.image.as_widget(attrs={
        "class": "form-control",
        "accept": "image/jpeg,image/png,image/webp,image/heic,image/heif,.jpg,.jpeg,.png,.webp,.heic,.heif",
        "data-max-size": "5242880",
        "data-preview-target": "mainImagePreview"
      }) }}

      <small class="text-muted d-block mt-2">
        Поддерживаемые форматы: JPG, PNG, WebP, HEIC/HEIF (до 5MB).<br>
        Изображение будет автоматически сжато и оптимизировано.
      </small>

      <div id="mainImagePreview" class="mt-2 d-flex gap-2 flex-wrap"></div>

      {% if form.image.errors %}
        <div class="invalid-feedback d-block text-danger mt-2">{{ form.image.errors.0 }}</div>
      {% endif %}
    </div>

  </div>

  <!-- Дополнительные изображения -->
  <div class="card shadow-sm p-4 mb-4">
    <div class="mb-2">
      <label class="form-label">Дополнительные фото</label>

      {{ formset.management_form }}

      {% if formset.non_form_errors %}
        <div class="alert alert-danger">
          {% for e in formset.non_form_errors %}{{ e }}{% endfor %}
        </div>
      {% endif %}

      <div id="additional-images-container" class="d-grid gap-3">
        {% for ai_form in formset %}
          <div class="additional-image-form">
            {% with preview_id="preview-"|add:ai_form.prefix %}
              {{ ai_form.image.as_widget(attrs={
                "class": "form-control",
                "accept": "image/jpeg,image/png,image/webp,image/heic,image/heif,.jpg,.jpeg,.png,.webp,.heic,.heif",
                "data-max-size": "5242880",
                "data-preview-target": preview_id
              }) }}

              <div id="{{ preview_id }}" class="mt-2 d-flex gap-2 flex-wrap"></div>
            {% endwith %}

            {% if ai_form.non_field_errors %}
              <small class="text-danger d-block mt-1">
                {% for e in ai_form.non_field_errors %}❌ {{ e }}{% endfor %}
              </small>
            {% endif %}

            {% if ai_form.image.errors %}
              <small class="text-danger d-block mt-1">
                {% for e in ai_form.image.errors %}❌ {{ e }}{% endfor %}
              </small>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="text-end">
    {% bootstrap_button button_text button_type='submit' button_class='btn-primary' %}
  </div>
</form>

<script src="{% static 'js/bb_form.js' %}"></script>